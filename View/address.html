<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Endereço</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 50px;
        }

        h1 {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Cadastro de Endereço</h1>
        <form id="addressForm">
            <div class="form-group">
                <label for="userId">ID do Usuário</label>
                <input type="text" class="form-control" id="userId" placeholder="Digite o ID do usuário" required>
            </div>
            <div class="form-group">
                <label for="cep">CEP</label>
                <input type="text" class="form-control" id="cep" placeholder="Digite o CEP" required>
            </div>
            <div class="form-group">
                <label for="street">Rua</label>
                <input type="text" class="form-control" id="street" placeholder="Digite a rua" required>
            </div>
            <div class="form-group">
                <label for="number">Número</label>
                <input type="text" class="form-control" id="number" placeholder="Digite o número" required>
            </div>
            <div class="form-group">
                <label for="complement">Complemento</label>
                <input type="text" class="form-control" id="complement" placeholder="Digite o complemento (opcional)">
            </div>
            <div class="form-group">
                <label for="neighborhood">Bairro</label>
                <input type="text" class="form-control" id="neighborhood" placeholder="Digite o bairro" required>
            </div>
            <div class="form-group">
                <label for="city">Cidade</label>
                <input type="text" class="form-control" id="city" placeholder="Digite a cidade" required>
            </div>
            <div class="form-group">
                <label for="state">Estado</label>
                <input type="text" class="form-control" id="state" placeholder="Digite o estado (UF)" required>
            </div>
            <button type="submit" class="btn btn-primary">Cadastrar Endereço</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const email = getEmailFromStorage();
            if (email) {
                console.log('Email recuperado:', email);

                try {
                    const response = await fetch(`/api/users/email?email=${encodeURIComponent(email)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Erro ao recuperar usuário pelo email');
                    }

                    const userData = await response.json();
                    console.log('Dados do usuário recuperado:', userData);

                    // O valor do UID está dentro de uma string JSON no campo "message"
                    const userObject = JSON.parse(userData.message); // Analisa a string JSON
                    const idUsuario = userObject.Uid; // Atribui o UID à variável

                    alert('ID do Usuário: ' + idUsuario); // Mostra o ID do usuário em um alert
                    document.getElementById('userId').value = idUsuario; // Preenche o campo ID com o UID
                } catch (error) {
                    console.error('Erro ao recuperar usuário:', error);
                    alert('Erro ao recuperar os dados do usuário.');
                }
            } else {
                console.log('Nenhum email encontrado no sessionStorage.');
            }
        });

        function getEmailFromStorage() {
            return localStorage.getItem('email');
        }

        document.getElementById('addressForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const UserId = document.getElementById('userId').value;
            const PostalCode = document.getElementById('cep').value;
            const Street = document.getElementById('street').value;
            const Number = document.getElementById('number').value;
            const Complement = document.getElementById('complement').value;
            const Neighborhood = document.getElementById('neighborhood').value;
            const City = document.getElementById('city').value;
            const State = document.getElementById('state').value;

            const addressData = {
                UserId: UserId,
                PostalCode: PostalCode,
                Street: Street,
                Number: Number,
                Complement: Complement,
                Neighborhood: Neighborhood,
                City: City,
                State: State
            };
            try {
                const response = await fetch('/api/address', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(addressData)
                });

                if (!response.ok) {
                    throw new Error('Erro ao cadastrar o endereço');
                }

                alert('Endereço cadastrado com sucesso!');
            } catch (error) {
                console.error('Erro ao cadastrar o endereço:', error);
                alert('Erro ao cadastrar o endereço.');
            }
        });
    </script>
</body>
</html>
